<!-- =============================
PARTIE 1 ‚Äî PUBLIC (index.html)
============================== --><!doctype html>

<html lang="fr">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Unit√© Rapide ‚Äì Boutique</title>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">
  <style>
    :root{
      --bg:#0e1726; --card:#111a2b; --text:#e6eefc; --muted:#9fb0ca; --accent:#30d158;
      --primary:#4e9eff; --chip:#1b263b; --danger:#ff5d5d; --gold:#ffcc00;
    }
    *{box-sizing:border-box}
    html,body{margin:0;background:linear-gradient(120deg,#0b1220,#0e1726 40%,#0b1324);color:var(--text);font-family:Inter,system-ui,Segoe UI,Roboto,Arial,sans-serif}
    a{color:inherit;text-decoration:none}
    .wrap{max-width:1100px;margin:auto;padding:18px}
    header{display:flex;gap:12px;align-items:center;justify-content:space-between;margin:8px 0 16px}
    .brand{font-weight:800;letter-spacing:.3px}
    .pill{background:#0b213f;border:1px solid #123058;color:#cfe2ff;padding:8px 12px;border-radius:999px}
    .grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(280px,1fr));gap:16px}
    .card{background:radial-gradient(1200px 300px at -20% -20%,#19263f,transparent),var(--card);border:1px solid #1e2a43;border-radius:18px;box-shadow:0 10px 30px rgba(0,0,0,.25);overflow:hidden}
    .imgbox{position:relative;height:220px;background:#0b1528;display:grid;place-items:center}
    .imgbox img{width:100%;height:100%;object-fit:cover}
    .thumbs{position:absolute;left:10px;bottom:10px;display:flex;gap:6px}
    .thumbs img{width:42px;height:42px;border-radius:10px;border:1px solid #22314f;cursor:pointer;opacity:.8}
    .thumbs img.active{outline:2px solid var(--primary);opacity:1}
    .body{padding:14px}
    .title{font-weight:700;margin:0 0 4px;font-size:18px}
    .cat{color:var(--muted);font-size:13px;margin-bottom:10px}
    .price{display:flex;align-items:baseline;gap:8px;font-weight:800}
    .price small{color:var(--muted);font-weight:600}
    .row{display:flex;gap:10px;flex-wrap:wrap}
    .btn{flex:1;display:inline-flex;align-items:center;justify-content:center;gap:8px;padding:12px 14px;border-radius:14px;border:1px solid #203456;background:#0e213f;color:#d9e7ff;font-weight:700;cursor:pointer}
    .btn.primary{background:linear-gradient(180deg,#2c74ff,#1550cf);border-color:#2a5fd1}
    .btn.green{background:linear-gradient(180deg,#39d47c,#12a150);border-color:#0e8a44}
    .btn.blue{background:linear-gradient(180deg,#4db9ff,#1a7bd9);border-color:#166ec0}
    .chip{display:inline-flex;gap:6px;align-items:center;background:var(--chip);border:1px solid #263653;color:#d2e3ff;padding:6px 10px;border-radius:999px;font-size:12px}
    .stats{display:flex;gap:10px;margin:10px 0 2px}
    .stats .chip{background:#0d1b33}
    footer{margin:40px 0 20px;color:var(--muted);text-align:center}
    /* MODAL */
    .modal{position:fixed;inset:0;background:rgba(0,0,0,.55);display:none;place-items:center;padding:18px;z-index:50}
    .modal.open{display:grid}
    .panel{width:min(520px,96vw);background:linear-gradient(160deg,#0e1a2e,#0a1930);border:1px solid #1f2f4c;border-radius:16px;box-shadow:0 20px 50px rgba(0,0,0,.45);overflow:hidden}
    .panel header{padding:14px 16px;border-bottom:1px solid #213150}
    .panel .content{padding:16px}
    .paylist{display:grid;gap:10px}
    .payitem{display:flex;justify-content:space-between;align-items:center;gap:10px;background:#0c1a33;border:1px solid #1d2f53;border-radius:12px;padding:12px}
    .hint{color:#a9bfdc;font-size:13px}
    .copy{cursor:pointer}
    .ok{margin-top:14px}
    .searchBar{display:flex;gap:8px;flex-wrap:wrap;margin:10px 0 18px}
    .searchBar input,.searchBar select{background:#0d1b33;border:1px solid #213150;color:#e6f0ff;border-radius:12px;padding:10px 12px;outline:none}
    .banner{display:flex;gap:12px;align-items:center;justify-content:center;background:linear-gradient(120deg,#1c2e55,#10386a);border:1px dashed #25518f;color:#d7e7ff;border-radius:16px;padding:10px;margin-bottom:12px}
  </style>
</head>
<body>
  <div class="wrap">
    <header>
      <div class="brand">üá®üá© Unit√© Rapide ‚Äî Boutique</div>
      <div class="row">
        <a class="pill" href="admin.html">Admin</a>
        <span class="pill">Paiement principal : <strong>Airtel Money</strong></span>
      </div>
    </header><div class="banner">
  <span>‚ú® Promo du jour : livraison rapide & assistance WhatsApp/Telegram</span>
</div>

<div class="searchBar">
  <input id="q" type="search" placeholder="Rechercher un produit‚Ä¶" />
  <select id="cat">
    <option value="">Toutes cat√©gories</option>
  </select>
</div>

<div id="grid" class="grid"></div>

<footer>
  <div>¬© <span id="year"></span> Unit√© Rapide ‚Äî RDC. Tous droits r√©serv√©s.</div>
  <div style="margin-top:6px">Contact : <a id="waSmall" href="#">WhatsApp</a> ¬∑ <a id="tgSmall" href="#">Telegram</a></div>
</footer>

  </div>  <!-- MODAL ACHAT / PAIEMENT -->  <div id="modal" class="modal">
    <div class="panel" role="dialog" aria-modal="true">
      <header>
        <strong>Moyen de paiement</strong>
        <div style="margin-left:auto"><button id="mClose" class="pill">Fermer</button></div>
      </header>
      <div class="content">
        <div id="mBody"></div>
        <div class="ok">
          <a id="btnProof" class="btn blue" href="#" target="_blank">Envoyer la preuve sur WhatsApp</a>
        </div>
      </div>
    </div>
  </div><script>
/* ==========================
   CONFIG (modifiable en admin)
============================= */
const SETTINGS = JSON.parse(localStorage.getItem('ur_settings')||'{}');
const PHONE = SETTINGS.phone || '+243990564877';
const OWNER = SETTINGS.owner || 'Mugisho St√©phane';
const TELEGRAM = SETTINGS.telegram || 'cphkkk66';
const CURRENCY = 'FC';
const DOLLAR_RATE = SETTINGS.usdRate || 2800; // exemple conversion FC -> $

// Sources Google Sheets (pubHTML -> auto transform en CSV)
const SHEETS = SETTINGS.sheets || [
  'https://docs.google.com/spreadsheets/d/e/2PACX-1vRNgEaiSzpwmHuoj1bfIFzi9A34beLlxoqz8_ocD5hvb7I2T-4GRcamMbFRCKvw5-lKivYqo3Kpg0Ti/pubhtml?gid=0&single=true',
  'https://docs.google.com/spreadsheets/d/e/2PACX-1vRNgEaiSzpwmHuoj1bfIFzi9A34beLlxoqz8_ocD5hvb7I2T-4GRcamMbFRCKvw5-lKivYqo3Kpg0Ti/pubhtml?gid=2097070430&single=true',
  'https://docs.google.com/spreadsheets/d/e/2PACX-1vQ7yaRVA16yeVYrB9YAGs_ckiodiHqMns2igOT2ozVM92EXoBOJpCoxZzZ3NLxmHY1G_KqvYKZfvjTS/pubhtml?gid=0&single=true'
];

function pubHtmlToCsv(url){
  const u=new URL(url); const gid=u.searchParams.get('gid')||'0';
  return url.replace('pubhtml','pub').replace('single=true','').replace(/\?gid=.*$/,'')+`?output=csv&gid=${gid}`;
}

/* ==========================
   UI helpers
============================= */
const grid = document.getElementById('grid');
const catSel = document.getElementById('cat');
const qInput = document.getElementById('q');
const yearEl = document.getElementById('year');
const modal = document.getElementById('modal');
const mBody = document.getElementById('mBody');
const mClose = document.getElementById('mClose');
const btnProof = document.getElementById('btnProof');

function fmt(fc){ return new Intl.NumberFormat('fr-CD').format(fc)+` ${CURRENCY}` }
function usd(fc){ return `(~ ${Math.round(fc/DOLLAR_RATE)} $)` }

function setSmallLinks(){
  document.getElementById('waSmall').href = `https://wa.me/${PHONE.replace(/\D/g,'')}`;
  document.getElementById('tgSmall').href = `https://t.me/${TELEGRAM}`;
}

/* ==========================
   DATA: charger CSV de Google Sheets
============================= */
async function fetchCSV(url){
  const res = await fetch(url); const txt = await res.text();
  const rows = txt.split(/\r?\n/).filter(Boolean).map(r=>r.split(','));
  const head = rows.shift().map(h=>h.trim().toLowerCase());
  return rows.map(r=>{
    const obj={}; head.forEach((h,i)=>obj[h]=r[i]||''); return obj;
  });
}

async function loadProducts(){
  let all=[]; for(const h of SHEETS){ try{ const csv=pubHtmlToCsv(h); const rows=await fetchCSV(csv); all=all.concat(rows);}catch(e){console.warn('Sheet error',e)} }
  // mapping attendu: name, price, category, img1..img5, description
  const mapped = all.filter(r=>r.name||r.nom).map(r=>({
    id: (r.id||crypto.randomUUID()),
    name: r.name||r.nom,
    price: Number((r.price||r.prix||'0').toString().replace(/\D/g,''))||0,
    category: r.category||r.categorie||'Autres',
    images: [r.img1,r.img2,r.img3,r.img4,r.img5].filter(Boolean),
    desc: r.description||r.desc||''
  }));
  return mapped;
}

/* ==========================
   INTERACTIONS locales (vues, likes, commentaires)
============================= */
const store = {
  get(k,def){ try{ return JSON.parse(localStorage.getItem(k)) ?? def }catch{ return def } },
  set(k,v){ localStorage.setItem(k,JSON.stringify(v)) }
};
function keyFor(p,what){ return `ur_${what}_${p.id}` }
function addView(p){ const k=keyFor(p,'views'); const v=(store.get(k,0)+1); store.set(k,v); return v }
function toggleLike(p){ const k=keyFor(p,'liked'); const liked=!store.get(k,false); store.set(k,liked); const cK=keyFor(p,'likes'); let c=store.get(cK,0); c = liked? c+1 : Math.max(0,c-1); store.set(cK,c); return {liked,count:c} }
function getStats(p){ return {views:store.get(keyFor(p,'views'),0),likes:store.get(keyFor(p,'likes'),0),liked:store.get(keyFor(p,'liked'),false)} }
function addComment(p,txt){ const k=keyFor(p,'comments'); const list=store.get(k,[]); list.unshift({txt,at:Date.now()}); store.set(k,list); return list }
function getComments(p){ return store.get(keyFor(p,'comments'),[]) }

/* ==========================
   RENDER
============================= */
let PRODUCTS=[]; let FILTER={q:'',cat:''};

function productCard(p){
  const stats = getStats(p);
  const img = (p.images&&p.images[0]) || 'https://images.unsplash.com/photo-1513438205128-16af16280744?w=1200&q=60&auto=format&fit=crop';
  const el = document.createElement('div'); el.className='card';
  el.innerHTML = `
    <div class="imgbox">
      <img src="${img}" alt="${p.name}" onerror="this.src='https://picsum.photos/800/600?random=5'"/>
      <div class="thumbs">${(p.images.length? p.images: [img]).slice(0,5).map((u,i)=>`<img data-i="${i}" src="${u}" class="${i? '' : 'active'}"/>`).join('')}</div>
    </div>
    <div class="body">
      <div class="title">${p.name}</div>
      <div class="cat">${p.category}</div>
      <div class="price">${fmt(p.price)} <small>${usd(p.price)}</small></div>
      <div class="stats">
        <span class="chip">üëÅÔ∏è <span data-role="views">${stats.views}</span></span>
        <span class="chip">‚ù§Ô∏è <span data-role="likes">${stats.likes}</span></span>
      </div>
      <div class="row" style="margin-top:8px">
        <button class="btn green" data-act="wa">WhatsApp</button>
        <button class="btn blue" data-act="tg">Telegram</button>
      </div>
      <div class="row" style="margin-top:8px">
        <button class="btn primary" data-act="buy">Acheter</button>
        <button class="btn" data-act="like">J'aime</button>
      </div>
      <div class="row" style="margin-top:8px">
        <button class="btn" data-act="comment">Commenter</button>
        <button class="btn" data-act="share">Partager</button>
      </div>
    </div>`;

  // Thumbs switch
  const mainImg = el.querySelector('.imgbox img');
  el.querySelectorAll('.thumbs img').forEach(t=>{
    t.addEventListener('click',()=>{
      el.querySelectorAll('.thumbs img').forEach(x=>x.classList.remove('active'));
      t.classList.add('active'); mainImg.src = p.images[Number(t.dataset.i)] || mainImg.src;
    })
  });

  // Count a view when card appears
  const obs = new IntersectionObserver((entries)=>{
    entries.forEach(en=>{ if(en.isIntersecting){ const v=addView(p); el.querySelector('[data-role="views"]').textContent=v; obs.disconnect(); }});
  },{threshold:.5}); obs.observe(el);

  // Actions
  el.addEventListener('click',(e)=>{
    const btn = e.target.closest('button'); if(!btn) return; const act=btn.dataset.act;
    if(act==='wa') openWhatsApp(p);
    if(act==='tg') openTelegram(p);
    if(act==='buy') openBuy(p);
    if(act==='share') shareP(p);
    if(act==='like'){ const {liked,count}=toggleLike(p); el.querySelector('[data-role="likes"]').textContent=count; btn.textContent = liked? "J'aime ‚úì" : "J'aime" }
    if(act==='comment'){ const txt = prompt('Votre commentaire :'); if(txt){ addComment(p,txt); alert('‚úÖ Merci ! Votre commentaire est enregistr√© sur cet appareil.'); }}
  });

  return el;
}

function buildFilters(arr){
  const cats=[...new Set(arr.map(x=>x.category))].sort();
  cats.forEach(c=>{ const o=document.createElement('option'); o.value=c; o.textContent=c; catSel.appendChild(o); });
}

function render(arr){
  grid.innerHTML=''; const q=FILTER.q.toLowerCase(), cat=FILTER.cat;
  arr.filter(p => (!cat||p.category===cat) && (!q||p.name.toLowerCase().includes(q))).forEach(p=> grid.appendChild(productCard(p)) );
}

/* ==========================
   ACTIONS externes
============================= */
function openWhatsApp(p){
  const msg = encodeURIComponent(`Bonjour üëã\nJe suis int√©ress√© par: ${p.name}\nPrix: ${fmt(p.price)} ${usd(p.price)}\n`);
  window.open(`https://wa.me/${PHONE.replace(/\D/g,'')}?text=${msg}`, '_blank');
}
function openTelegram(p){
  const msg = encodeURIComponent(`Achat: ${p.name} ${fmt(p.price)} ${usd(p.price)}`);
  window.open(`https://t.me/${TELEGRAM}?start=${msg}`,'_blank');
}
function openBuy(p){
  modal.classList.add('open');
  const base = `Achat: ${p.name} ‚Äî ${fmt(p.price)} ${usd(p.price)}`;
  const rows = [
    {id:'airtel', label:'Airtel Money (principal)', hint:`Payer √† ${PHONE} ‚Äî ${OWNER}`},
    {id:'mpesa', label:'M-Pesa (Vodacom)', hint:'Indiquez le num√©ro au marchand'},
    {id:'orange', label:'Orange Money', hint:'Indiquez le num√©ro au marchand'},
    {id:'afri', label:'Afrimoney (Africell)', hint:'Indiquez le num√©ro au marchand'},
    {id:'mtn', label:'MoMo (MTN)', hint:'Indiquez le num√©ro au marchand'}
  ];
  mBody.innerHTML = `<div class="paylist">${rows.map(r=>`
    <div class="payitem">
      <div>
        <div><strong>${r.label}</strong></div>
        <div class="hint">${r.hint}</div>
      </div>
      <div class="chip copy" data-kind="${r.id}">üìã Copier</div>
    </div>`).join('')}</div>`;

  mBody.querySelectorAll('.copy').forEach(c=>{
    c.addEventListener('click',()=>{
      navigator.clipboard.writeText(`${PHONE} ‚Äî ${OWNER}`);
      c.textContent='Copi√© !'; setTimeout(()=>c.textContent='üìã Copier',1200);
    })
  });
  const proof = encodeURIComponent(`${base}\nMode: AIRTEL MONEY\nJ'ai pay√© √† ${PHONE} (${OWNER}). Voici ma preuve:`);
  btnProof.href = `https://wa.me/${PHONE.replace(/\D/g,'')}?text=${proof}`;
}
function shareP(p){
  const url = location.href.split('#')[0];
  const text = `üî• Regarde ${p.name} √† ${fmt(p.price)} chez Unit√© Rapide`;
  if(navigator.share){ navigator.share({title:'Unit√© Rapide',text, url}); }
  else{ prompt('Copie ce lien', url); }
}

/* ==========================
   INIT
============================= */
(async function init(){
  yearEl.textContent = new Date().getFullYear();
  setSmallLinks();
  PRODUCTS = await loadProducts();
  if(!PRODUCTS.length){ // fallback d√©mo (avec 5 images/produit)
    PRODUCTS = [
      {id:'demo1', name:'Basket tendance', price:120000, category:'Chaussures', images:[
        'https://images.unsplash.com/photo-1542291026-7eec264c27ff?w=1200&q=60&auto=format&fit=crop',
        'https://images.unsplash.com/photo-1542291026-7eec264c27ff?w=1000&q=60&auto=format&fit=crop',
        'https://picsum.photos/seed/shoe/900/600',
        'https://picsum.photos/seed/shoe2/900/600',
        'https://picsum.photos/seed/shoe3/900/600']},
      {id:'demo2', name:'Sac premium', price:95000, category:'Sacs', images:[
        'https://images.unsplash.com/photo-1548036328-c9fa89d128fa?w=1200&q=60&auto=format&fit=crop',
        'https://picsum.photos/seed/bag1/900/600',
        'https://picsum.photos/seed/bag2/900/600',
        'https://picsum.photos/seed/bag3/900/600',
        'https://picsum.photos/seed/bag4/900/600']}
    ];
  }
  buildFilters(PRODUCTS); render(PRODUCTS);
})();

qInput.addEventListener('input',()=>{ FILTER.q=qInput.value; render(PRODUCTS); });
catSel.addEventListener('change',()=>{ FILTER.cat=catSel.value; render(PRODUCTS); });
mClose.addEventListener('click',()=> modal.classList.remove('open'));
</script></body>
</html><!-- =============================
PARTIE 2 ‚Äî ADMIN (admin.html)
============================== --><!doctype html>

<html lang="fr">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Admin ‚Äî Unit√© Rapide</title>
  <style>
    :root{--bg:#0b1220;--panel:#0f1b31;--text:#e8f0ff;--muted:#a8bddc;--accent:#4db9ff;--good:#2ecc71;--warn:#ffb020}
    body{margin:0;background:linear-gradient(120deg,#0b1220,#0e1726);color:var(--text);font-family:Inter,system-ui,Arial}
    .wrap{max-width:1000px;margin:auto;padding:18px}
    h1{margin:6px 0 14px}
    .panel{background:var(--panel);border:1px solid #1a2c4a;border-radius:14px;padding:14px;margin:12px 0}
    label{font-size:14px;color:var(--muted)}
    input,textarea{width:100%;padding:10px 12px;border-radius:12px;border:1px solid #23385c;background:#0a1529;color:#e9f1ff;outline:none}
    .row{display:flex;gap:10px;flex-wrap:wrap}
    .btn{padding:10px 14px;border-radius:12px;border:1px solid #21406b;background:#0c2040;color:#e6f0ff;font-weight:700;cursor:pointer}
    .btn.good{background:#174a2f;border-color:#1f6b45}
    .btn.warn{background:#553a12;border-color:#7a5216}
    .kv{display:grid;grid-template-columns:160px 1fr;gap:12px;align-items:center}
    .small{color:var(--muted);font-size:12px}
    .grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(260px,1fr));gap:12px}
    .card{background:#0a1630;border:1px solid #1b2e58;border-radius:12px;padding:12px}
  </style>
</head>
<body>
  <div class="wrap">
    <h1>Admin ‚Äî Unit√© Rapide</h1><div id="login" class="panel">
  <div class="kv">
    <label>PIN administrateur</label>
    <input id="pinIn" type="password" placeholder="Entrez le PIN (d√©faut 6996698877)">
  </div>
  <div style="margin-top:10px"><button id="openBtn" class="btn">Ouvrir</button></div>
  <div class="small">Astuce : modifiez votre PIN ci‚Äëdessous apr√®s connexion.</div>
</div>

<div id="app" style="display:none">
  <div class="panel">
    <h3>Alertes</h3>
    <div class="small">Toutes les op√©rations sont c√¥t√© navigateur (local). Exportez r√©guli√®rement vos donn√©es.</div>
  </div>

  <div class="panel">
    <h3>Param√®tres</h3>
    <div class="kv"><label>Nouveau PIN</label><input id="newPin" type="password" placeholder="Changer le PIN"></div>
    <div class="kv"><label>Compte de retrait (Airtel Money)</label><input id="phone" placeholder="Ex: +243990564877"></div>
    <div class="kv"><label>Nom du b√©n√©ficiaire</label><input id="owner" placeholder="Mugisho St√©phane"></div>
    <div class="kv"><label>WhatsApp (num√©ro)</label><input id="wa" placeholder="+243990564877"></div>
    <div class="kv"><label>Telegram (username)</label><input id="tg" placeholder="cphkkk66"></div>
    <div class="kv"><label>Taux FC ‚Üí $</label><input id="usdRate" type="number" placeholder="2800"></div>
    <div class="kv"><label>Google Sheets (1 par ligne ‚Äì pubHTML)</label><textarea id="sheets" rows="4"></textarea></div>
    <div style="margin-top:10px" class="row">
      <button id="saveSet" class="btn good">Enregistrer</button>
      <button id="resetSet" class="btn warn">R√©initialiser (local)</button>
    </div>
  </div>

  <div class="panel">
    <h3>Produits (lecture des Sheets)</h3>
    <div class="small">Colonnes attendues : name/nom, price/prix, category/categorie, img1..img5, description.</div>
    <div class="row" style="margin:10px 0">
      <button id="reload" class="btn">Recharger</button>
      <button id="exportJson" class="btn">Exporter JSON</button>
    </div>
    <div id="products" class="grid"></div>
  </div>

  <div class="panel">
    <h3>Historique (likes/commentaires)</h3>
    <div class="row" style="margin:8px 0">
      <button id="exportLocal" class="btn">Exporter (localStorage)</button>
      <button id="clearLocal" class="btn warn">Nettoyer (local)</button>
    </div>
    <pre id="log" style="white-space:pre-wrap"></pre>
  </div>
</div>

  </div><script>
const DEFAULT_PIN = '6996698877';
const KEY_PIN = 'ur_admin_pin';
const KEY_SETTINGS = 'ur_settings';

function getPin(){ return localStorage.getItem(KEY_PIN) || DEFAULT_PIN }
function setPin(v){ localStorage.setItem(KEY_PIN, v) }

function loadSettings(){ try{ return JSON.parse(localStorage.getItem(KEY_SETTINGS))||{} }catch{return {}} }
function saveSettings(s){ localStorage.setItem(KEY_SETTINGS, JSON.stringify(s)) }

function pubHtmlToCsv(url){
  try{ const u=new URL(url); const gid=u.searchParams.get('gid')||'0'; return url.replace('pubhtml','pub').replace('single=true','')+`&output=csv&gid=${gid}` }catch{ return url }
}
async function fetchCSV(url){ const res=await fetch(url); const txt=await res.text(); const rows=txt.split(/\r?\n/).filter(Boolean).map(r=>r.split(',')); const head=rows.shift().map(h=>h.trim().toLowerCase()); return rows.map(r=>{const o={}; head.forEach((h,i)=>o[h]=r[i]||''); return o;}); }

// Login
const login = document.getElementById('login');
const app = document.getElementById('app');
openBtn.onclick = ()=>{
  const ok = (pinIn.value||'') === getPin();
  if(ok){ login.style.display='none'; app.style.display='block'; fillSettings(); loadAndRender(); }
  else alert('PIN incorrect');
}

function fillSettings(){
  const s = loadSettings();
  phone.value = s.phone || '+243990564877';
  owner.value = s.owner || 'Mugisho St√©phane';
  wa.value = s.phone || '+243990564877';
  tg.value = s.telegram || 'cphkkk66';
  usdRate.value = s.usdRate || 2800;
  sheets.value = (s.sheets || [
    'https://docs.google.com/spreadsheets/d/e/2PACX-1vRNgEaiSzpwmHuoj1bfIFzi9A34beLlxoqz8_ocD5hvb7I2T-4GRcamMbFRCKvw5-lKivYqo3Kpg0Ti/pubhtml?gid=0&single=true',
    'https://docs.google.com/spreadsheets/d/e/2PACX-1vRNgEaiSzpwmHuoj1bfIFzi9A34beLlxoqz8_ocD5hvb7I2T-4GRcamMbFRCKvw5-lKivYqo3Kpg0Ti/pubhtml?gid=2097070430&single=true',
    'https://docs.google.com/spreadsheets/d/e/2PACX-1vQ7yaRVA16yeVYrB9YAGs_ckiodiHqMns2igOT2ozVM92EXoBOJpCoxZzZ3NLxmHY1G_KqvYKZfvjTS/pubhtml?gid=0&single=true'
  ]).join('\n');
}

saveSet.onclick = ()=>{
  const s = loadSettings();
  if(newPin.value){ setPin(newPin.value); newPin.value=''; alert('‚úÖ PIN modifi√©'); }
  const list = sheets.value.split(/\n+/).map(x=>x.trim()).filter(Boolean);
  const out = { phone:phone.value.trim(), owner:owner.value.trim(), telegram:tg.value.trim(), usdRate:Number(usdRate.value)||2800, sheets:list };
  saveSettings({...s,...out}); alert('‚úÖ Param√®tres enregistr√©s');
}
resetSet.onclick = ()=>{ if(confirm('Effacer param√®tres locaux ?')){ localStorage.removeItem(KEY_SETTINGS); localStorage.removeItem(KEY_PIN); alert('R√©initialis√©. Rechargez la page.'); location.reload(); } }

async function loadAndRender(){
  products.innerHTML='Chargement‚Ä¶';
  const s = loadSettings();
  let arr=[]; for(const h of (s.sheets||[])){ try{ const csv=pubHtmlToCsv(h); const rows=await fetchCSV(csv); arr=arr.concat(rows);}catch(e){ console.warn(e) } }
  const mapped = arr.filter(r=>r.name||r.nom).map(r=>({
    id: r.id || crypto.randomUUID(),
    name: r.name||r.nom,
    price: Number((r.price||r.prix||'0').toString().replace(/\D/g,''))||0,
    category: r.category||r.categorie||'Autres',
    images: [r.img1,r.img2,r.img3,r.img4,r.img5].filter(Boolean)
  }));
  products.innerHTML = mapped.map(p=>
    `<div class="card"><strong>${p.name}</strong><div class="small">${p.category} ‚Äî ${p.price} FC</div><div class="small">Images: ${p.images.length}</div></div>`
  ).join('') || '<div class="small">Aucun produit lu. V√©rifiez vos liens Google Sheets.</div>';
}
reload.onclick = loadAndRender;

// Export/Import localStorage interactions
exportLocal.onclick = ()=>{
  const dump = Object.keys(localStorage).filter(k=>k.startsWith('ur_') && !k.includes('settings') && !k.includes('admin')).reduce((acc,k)=>{acc[k]=localStorage.getItem(k);return acc;},{});
  const blob = new Blob([JSON.stringify(dump,null,2)],{type:'application/json'});
  const a = document.createElement('a'); a.href = URL.createObjectURL(blob); a.download='ur-local-backup.json'; a.click();
}
clearLocal.onclick = ()=>{
  if(confirm('Effacer likes/commentaires/vues stock√©s localement ?')){
    Object.keys(localStorage).forEach(k=>{ if(k.startsWith('ur_') && !k.includes('settings') && !k.includes('admin')) localStorage.removeItem(k); });
    alert('Nettoy√©.');
  }
}
exportJson.onclick = ()=>{
  const s = loadSettings();
  const blob = new Blob([JSON.stringify(s,null,2)],{type:'application/json'});
  const a = document.createElement('a'); a.href = URL.createObjectURL(blob); a.download='ur-settings.json'; a.click();
}
</script></body>
      </html>
